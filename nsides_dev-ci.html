<!-- nSides, Updated July 2017

Copyright (C) 2017, Tatonetti Lab
Victor Nwankwo <vtn2106@cumc.columbia.edu>
Tal Lorberbaum <tal.lorberbaum@columbia.edu>
Joe Romano <dr2160@cumc.columbia.edu>
Ram Vanguri <rami.vanguri@columbia.edu>
Nicholas P. Tatonetti <nick.tatonetti@columbia.edu>
All rights reserved.

This site is released under a CC BY-NC-SA 4.0 license.
For full license details see LICENSE.txt at 
https://github.com/tatonetti-lab/nsides or go to:
http://creativecommons.org/licenses/by-nc-sa/4.0/
-->

<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>nSides - A comprehensive database of drug-drug(s)-effect relationships - Tatonetti Lab</title>
    <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="keywords" content="API">
    <meta name="description" content="">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
     
<!--    <link rel="apple-touch-icon" href="/index/img/apple-touch-icon.png">-->
    <link rel="shortcut icon" href="/index/img/favicon.ico">
    

    <!-- Stylesheets for scaffold and fonts -->
    <link type="text/css" rel="stylesheet" media="all" href="./index/misc/fonts.css">
    <link type="text/css" rel="stylesheet" media="all" href="./index/misc/main.css">
    <link type="text/css" rel="stylesheet" media="print" href="./index/misc/print.css">
    <!-- styles for select bar -->
    <link rel="stylesheet" href="./index/css/react-select.css">
</head>
    
<style>
    html, body
    {
        width: 100%;
        height: 100%;

        margin: 0;
        padding: 0;
    }

    

    svg {
        margin-left: auto; margin-right: auto;
        display: block;
    }

    line,
    rect {
        shape-rendering: crispEdges;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .x.axis path {
        display: none;
    }

    .divider {
        stroke: #777;
        stroke-dasharray: 5,5;
        opacity: 0.7;
    }

    .line {
        fill: none;
        stroke-width: 1.5px;
    }

    circle.dot {
        fill: #FFF;
        stroke-width: 1.5px;
    }

    .area.confidence {
        zoom: 1;
        filter: alpha(opacity=30);
        opacity: 0.3;
    }

/**
.area.above {
    fill: #D7191C !important;
}

.area.below {
    fill: #2B83BA !important;
}
*/
</style>

<style>
  .h2o-est {
    white-space: nowrap;
  }
  html, body
  {
    width: 100%;
    height: 100%;
    
    margin: 0;
    padding: 0;

  }


  #page {
    height:100%;

  }

  #root {
    /*height:100%;*/
    flex: 1;
  }

  #header {
    flex: 0 1 auto;
    /* The above is shorthand for:
    flex-grow: 0,
    flex-shrink: 1,
    flex-basis: auto
    */

  }
  #header-content {
    position:relative;
    padding-top:40px;
    height:120px;
    vertical-align: bottom;
  }

  #content {
    height:100%;
    width:100%;
    display: flex;
    flex-direction: column;
    
    justify-content: flex-start; /* align items in Main Axis */
    align-items: stretch; /* align items in Cross Axis */
    align-content: stretch; /* Extra space in Cross Axis */
            
    background: rgba(255, 255, 255, .1);
    /*flex: 1;*/
  }

  header, section, footer {
    max-width:850px;
    width: 100%;
    margin: 0 auto;
  }

  #bar {
    width: 100vw;
    margin-left: calc(-50vw + 50%);
  }
  .drug_title {
    font-size: 22px;
    font-weight:bold;
    padding-top:25px;
    padding-bottom:5px;
  }

  .effect_title {
    font-size: 22px;
    font-weight:bold;
    padding-top:15px;
    padding-bottom:5px;
  }

  #viz_container {
        font: 10px sans-serif;

    }

    .select_container_effect {
        padding-left:10px;
    }
    .select_container, .select_container_effect {
        display: inline-block;
        width:45%;
    }

    .y text { display: none; }

    .y text text-anchor { display: visible; }
  </style>

<body>
<div id="content">

    <div id="header">
        <img class="logo" src="./index/img/wormhole.png" height="120px"/>
        <div id="header-content">
            <div>
                <h1><img src="/index/img/nsides-logo.svg" style="height:50px;vertical-align:middle;" /> nSides</h1>
                <h3 style="white-space: nowrap;">A comprehensive database of drug-drug(s)-effect relationships</h3>
            </div>
        </div>
    </div>

    <div id="bar"></div>

    <section>
        <div class="select_container">
            <div class="drug_title">Drug</div>
            <div id="select_drug_container"></div>
        </div>
        <div class="select_container_effect">
            <div class="effect_title">Effect</div>
            <div id="select_effect_container"></div>
        </div>

        <br>
        <div id="viz_container"></div><br><br><br><br><br>
    </section>

    <footer>
        <div id="footer">
            <img src="./index/misc/cumc.png" width="250px">
        </div>
    </footer>
</div><!-- end #content -->

<script src="/index/js/react.min.js"></script> 
<script src="/index/js/react-dom.min.js"></script>
<script src="/index/js/three.min.js"></script>
<script src="/index/js/index.js"></script>
<script src="/index/js/react-input-autosize.min.js"></script>
<script src="/index/js/react-select-mod.js"></script> <!-- Updated to close menu after hitting Enter -->
<script src="/index/js/drugs-brandnames-v4b.js"></script>

<script>
    // var options = [
    //     { label: 'One', value: 1 },
    //     { label: 'Two', value: 2 },
    //     { label: 'Three', value: 3 },
    // ];
    var options = drugs;
    var Container = React.createClass({
        getInitialState () {
            return { value: '' };
        },
        updateValue (value) {
            this.setState({ value: value });
        },
        render () {
            return React.createElement(Select, {
                options: options,
                onChange: this.updateValue,
                value: this.state.value,
            });
        }
    });
    React.render(
        React.createElement(Container),
        document.getElementById('select_drug_container')
    );

    var effect_options = [
        { label: 'snomed', value: 'snomed lookup' },
    ];
    var effect_Container = React.createClass({
        getInitialState () {
            return { value: '' };
        },
        updateValue (value) {
            this.setState({ value: value });
        },
        render () {
            return React.createElement(Select, {
                options: effect_options,
                onChange: this.updateValue,
                value: this.state.value,
            });
        }
    });
    React.render(
        React.createElement(effect_Container),
        document.getElementById('select_effect_container')
    );
</script>




    <script src="./index/js/d3.min.js?v=3.2.8"></script>
    <script type="text/javascript" charset="utf-8">
        // Return standard error with 95% confidence
        function se95(p, n) {
            return Math.sqrt(p*(1-p)/n)*1.96;
        };

        // Settings
        var width = 440,
            height = 400,
            padding = 30;

        var margin = {
            'top': 30,
            'right': 35,
            'bottom': 30,
            'left': 30
        };

        margin.hor = margin.left + margin.right;
        margin.ver = margin.top + margin.bottom;

        // Config
        // NOTE: This is where the magic happens (for now) ... instead of calling for a CSV file, we will call the API route
        var dataset = "./index/data/data.csv",
            parseDate = d3.time.format("%Y").parse,
            electionDate = "",  // "2014/11"
            interpolation = "linear";

        var estimateOne = ["Methadone"],
            estimateOneColor = "#D7191C", // blue
            estimateTwo = ["V", "O", "K", "I", "C"],
            estimateTwoColor = "#2B83BA", // red
            //displaySingleEstimate = false;
            displaySingleEstimate = "left"
            // false, "left", "right"

        var useEstimateLabels = true,
            yAxisTitle = "PRR",
            cutoff = .1;

        if (useEstimateLabels === true) { margin.right = 70; }
        // for the labels; 40 + 10 for each array.length > 4

        var x = d3.time.scale()
            .range([0, width]);

        var y = d3.scale.linear()
            .range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .ticks(7)
            .tickSubdivide(2);

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .tickFormat(d3.format(""));
            //.tickFormat(d3.format(".0"));
            //.tickFormat(d3.format(".0"));

        var lineLeft = d3.svg.area()
            .interpolate(interpolation)
            .x(function(d) { return x(d["date"]); })
            .y(function(d) { return y(d["left"]); });

        var lineRight = d3.svg.area()
            .interpolate(interpolation)
            .x(function(d) { return x(d["date"]); })
            .y(function(d) { return y(d["right"]); });

        var confidenceAreaLeft = d3.svg.area()
            .interpolate(interpolation)
            .x(function(d) { return x(d["date"]); })
            .y0(function(d) {
                return y(d["left"] - d["confidenceRight"]); })
            .y1(function(d) {
                return y(d["left"] + d["confidenceRight"]); });

        var confidenceAreaRight = d3.svg.area()
            .interpolate(interpolation)
            .x(function(d) { return x(d["date"]); })
            .y0(function(d) {
                return y(d["right"] - d["confidenceRight"]); })
            .y1(function(d) {
                return y(d["right"] + d["confidenceRight"]); });

        //var svg = d3.select("body").append("svg")
        var svg = d3.select("#viz_container").append("svg")
            .attr({
                "width": width + margin.left + margin.right,
                "height": height + margin.top + margin.bottom
            })
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        d3.csv(dataset, function(error, data) {
            data.forEach(function(d) {
                d.date = parseDate(d.date);
                d.respondents = parseFloat(d.respondents);

                estimateSum = function(d, estimate) {
                    var votes = parseFloat(0);
                    for (var i = 0; i < estimate.length; i++) {
                        votes += parseFloat(d[estimate[i]])
                    }
                    // Return percentage in decimal format
                    return votes>1 ? votes/100 : votes;
                };
                estimate = function(d, estimate) {
                    var votes = parseFloat(0);
                    for (var i = 0; i < estimate.length; i++) {
                        votes += parseFloat(d[estimate[i]])
                    }
                    // Return percentage in decimal format
                    return votes>1 ? votes/100 : votes;
                };
                d["left"] = estimate(d, estimateOne),
                d["right"] = estimate(d, estimateTwo),
                d["total"] = d["left"] + d["right"],
                d["confidenceLeft"] = se95(d["left"], d["respondents"]),
                d["confidenceRight"] = se95(d["right"], d["respondents"]);
            });

            if (electionDate === "") {
                x.domain(d3.extent(data, function(d) {
                    return d.date; }));
            } else {
                x.domain([
                    d3.min(data, function(d) { return d.date; }),
                    parseDate(electionDate)
                ]);
            }
            // y.domain([
            //     d3.min(data, function(d) {
            //         var min = Math.min(d["right"], d["left"]);
            //         return min - se95(min, d["respondents"]);
            //     }),
            //     d3.max(data, function(d) {
            //         var max = Math.max(d["right"], d["left"]);
            //         return max + se95(max, d["respondents"]);
            //     })
            // ]);
            y.domain([
                d3.min(data, function(d) {
                    var min = 0.1;
                    return min - se95(min, d["respondents"]);
                }),
                d3.max(data, function(d) {
                    //var max = Math.max(d["right"], d["left"]);
                    max = .25;
                    return max + se95(max, d["respondents"]);
                })
            ]);

            svg.datum(data);

            // X axis
            svg.append("g")
                .attr({
                    "class": "x axis",
                    "transform": "translate(0," + height + ")"
                })
                .call(xAxis);

            // Y axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr({
                    "transform": "rotate(-90)",
                    "y": 6,
                    "dy": ".71em"
                })
                .style("text-anchor", "end")
                .text(yAxisTitle);

            // Confidence area
            if (displaySingleEstimate !== "right") {
                svg.append("path")
                    .attr({
                        "class": "area confidence",
                        "fill": estimateOneColor,
                        "d": confidenceAreaLeft
                    });
            }
            if (displaySingleEstimate !== "left") {
                svg.append("path")
                    .attr({
                        "class": "area confidence",
                        "fill": estimateTwoColor,
                        "d": confidenceAreaRight
                    });
            }

            // Lines
            if (displaySingleEstimate !== "right") {
                svg.append("path")
                    .attr({
                        "class": "line",
                        "d": lineLeft,
                        "stroke": estimateOneColor
                    });
            }
            if (displaySingleEstimate !== "left") {
                svg.append("path")
                    .attr({
                        "class": "line",
                        "d": lineRight,
                        "stroke": estimateTwoColor
                    });
            }

            // Dots
            var dots = svg.selectAll("circle")
                .data(data)
                .enter();

            if (displaySingleEstimate !== "right") {
                var dotsLeft = dots.append("circle")
                    .attr({
                        "class": "dot",
                        "r": 3,
                        "cx": lineLeft.x(),
                        "cy": lineLeft.y(),
                        "stroke": estimateOneColor
                    });
            }
            if (displaySingleEstimate !== "left") {
                var dotsRight = dots.append("circle")
                    .attr({
                        "class": "dot",
                        "r": 3,
                        "cx": lineRight.x(),
                        "cy": lineRight.y(),
                        "stroke": estimateTwoColor
                    });
            }

            // Divider
            svg.append("line")
                .attr("class", "divider")
                .attr({
                    "x1": x.range()[0],
                    "x2": x.range()[1],
                    "y1": y(cutoff),
                    "y2": y(cutoff)
                });

            // Graph label
            if (useEstimateLabels === true) {
                if (displaySingleEstimate !== "right") {
                    svg.append("text")
                        .data(data)
                        .attr("transform", function(d) {
                            return "translate(" + x(data[data.length-1]["date"]) + "," + y(data[data.length-1]["left"]) + ")"; })
                        .attr({
                            "x": 10,
                            "dy": ".35em",
                            "class": "label",
                            "id": "estimateOne"
                        })
                        .text(estimateOne.join(""));
                }
                if (displaySingleEstimate !== "left") {
                    svg.append("text")
                        .data(data)
                        .attr("transform", function(d) {
                            return "translate(" + x(data[data.length-1]["date"]) + "," + y(data[data.length-1]["right"]) + ")"; })
                        .attr({
                            "x": 10,
                            "dy": ".35em",
                            "class": "label",
                            "id": "estimateTwo"
                        })
                        .text(estimateTwo.join(""));
                }
            }
        });
    </script>
</body>
</html>
